metadata:
  id: CUSTOM_AZURE_ROLE_ASSIGNMENT_PRINCIPALS
  name: Role assignments must specify principal_type and avoid privileged roles for Users
  category: IAM
  severity: HIGH
scope:
  provider: azure
definition:
  or:
    # Fail if principal_type is missing
    - and:
        - cond_type: attribute
          resource_types:
            - azurerm_role_assignment
          attribute: principal_type
          operator: not_exists
    # Fail if a User is granted highly privileged roles
    - and:
        - cond_type: attribute
          resource_types:
            - azurerm_role_assignment
          attribute: role_definition_name
          operator: within
          value:
            - Owner
            - Contributor
            - Key Vault Administrator
        - cond_type: attribute
          resource_types:
            - azurerm_role_assignment
          attribute: principal_type
          operator: equals
          value: User
